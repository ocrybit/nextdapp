{"ast":null,"code":"import _slicedToArray from \"@babel/runtime/helpers/esm/slicedToArray\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\n\nvar _this = this;\n\nfunction _createForOfIteratorHelper(o, allowArrayLike) { var it; if (typeof Symbol === \"undefined\" || o[Symbol.iterator] == null) { if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") { if (it) o = it; var i = 0; var F = function F() {}; return { s: F, n: function n() { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }, e: function e(_e) { throw _e; }, f: F }; } throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\"); } var normalCompletion = true, didErr = false, err; return { s: function s() { it = o[Symbol.iterator](); }, n: function n() { var step = it.next(); normalCompletion = step.done; return step; }, e: function e(_e2) { didErr = true; err = _e2; }, f: function f() { try { if (!normalCompletion && it[\"return\"] != null) it[\"return\"](); } finally { if (didErr) throw err; } } }; }\n\nfunction _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === \"string\") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === \"Object\" && o.constructor) n = o.constructor.name; if (n === \"Map\" || n === \"Set\") return Array.from(o); if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }\n\nfunction _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }\n\nimport { is, propOr, apply, isNil, hasPath, pickBy, identity, mergeLeft, invertObj, curryN, includes } from \"ramda\";\nimport { xNil } from \"nd/util\";\nimport { initFB } from \"nd/fb\";\nimport { setCookie, parseCookies, destroyCookie } from \"nookies\";\nimport { ns } from \"nd\";\nvar $ = ns(\"account\");\n\nvar NodeRSA = require(\"node-rsa\");\n\nvar base64url = require(\"base64url\");\n\nvar sha256 = require(\"js-sha256\");\n\nvar shortid = require(\"shortid\");\n\nvar err = function err(fn, ctx) {\n  return /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n    var ret,\n        err,\n        _len,\n        args,\n        _key,\n        _args = arguments;\n\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            ret = null;\n            err = null;\n            _context.prev = 2;\n\n            for (_len = _args.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n              args[_key] = _args[_key];\n            }\n\n            _context.next = 6;\n            return fn.apply(ctx || _this, args);\n\n          case 6:\n            ret = _context.sent;\n            _context.next = 12;\n            break;\n\n          case 9:\n            _context.prev = 9;\n            _context.t0 = _context[\"catch\"](2);\n            err = _context.t0;\n\n          case 12:\n            return _context.abrupt(\"return\", [err, ret]);\n\n          case 13:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee, null, [[2, 9]]);\n  }));\n};\n\nvar logAlert = function logAlert(obj, log, _alert_message) {\n  if (xNil(obj)) {\n    if (xNil(log)) console.log(log);\n    if (xNil(alert)) alert(_alert_message);\n  }\n\n  return xNil(err);\n};\n\nvar logging = false;\nvar conf, steem_client;\nvar name_map = {\n  \"twitter.com\": \"twitter\",\n  \"facebook.com\": \"facebook\",\n  \"google.com\": \"google\",\n  \"github.com\": \"github\",\n  \"alis.to\": \"alis\"\n};\nvar reverse_name_map = invertObj(name_map);\nvar link_converter = {\n  \"twitter.com\": function twitterCom(_u, add) {\n    return mergeLeft({\n      username: add.username,\n      id: add.profile.id_str,\n      about: add.profile.description,\n      image: add.profile.profile_image_url_https.replace(/_normal/, \"\")\n    }, _u);\n  },\n  \"facebook.com\": function facebookCom(_u, add) {\n    return mergeLeft({\n      name: add.profile.name,\n      image: hasPath([\"profile\", \"picture\", \"data\", \"url\"])(add) ? add.profile.picture.data.url : undefined\n    }, _u);\n  },\n  \"google.com\": function googleCom(_u, add) {\n    return mergeLeft({\n      name: add.profile.name,\n      image: add.profile.picture\n    }, _u);\n  },\n  \"github.com\": function githubCom(_u, add) {\n    return mergeLeft({\n      username: add.username,\n      name: add.profile.name,\n      about: add.profile.bio\n    }, _u);\n  },\n  \"alis.to\": function alisTo(_u, add) {\n    return mergeLeft({\n      name: add.user_display_name,\n      image: add.icon_image_url,\n      about: add.self_introduction,\n      username: add.user_id\n    }, _u);\n  }\n};\n\nvar userUpdate = /*#__PURE__*/function () {\n  var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(_ref2) {\n    var u, set, _ref2$global, db, account_nodb, user;\n\n    return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            u = _ref2.u, set = _ref2.set, _ref2$global = _ref2.global, db = _ref2$global.db, account_nodb = _ref2$global.account_nodb;\n\n            if (!isNil(u)) {\n              _context2.next = 5;\n              break;\n            }\n\n            _context2.t0 = null;\n            _context2.next = 13;\n            break;\n\n          case 5:\n            if (!account_nodb) {\n              _context2.next = 9;\n              break;\n            }\n\n            _context2.t1 = {\n              uid: u.uid,\n              name: u.displayName\n            };\n            _context2.next = 12;\n            break;\n\n          case 9:\n            _context2.next = 11;\n            return db.get(\"users\", u.uid);\n\n          case 11:\n            _context2.t1 = _context2.sent;\n\n          case 12:\n            _context2.t0 = _context2.t1;\n\n          case 13:\n            user = _context2.t0;\n            logging = false;\n            set({\n              user: user,\n              user_init: true\n            });\n\n          case 16:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2);\n  }));\n\n  return function userUpdate(_x) {\n    return _ref3.apply(this, arguments);\n  };\n}();\n\nexport var watchUser = /*#__PURE__*/function () {\n  var _ref5 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(_ref4) {\n    var _ref4$val, _ref4$val$nodb, nodb, cb, set, conf, global;\n\n    return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            _ref4$val = _ref4.val, _ref4$val$nodb = _ref4$val.nodb, nodb = _ref4$val$nodb === void 0 ? false : _ref4$val$nodb, cb = _ref4$val.cb, set = _ref4.set, conf = _ref4.conf, global = _ref4.global;\n            global.account_nodb = nodb;\n            initFB({\n              set: set,\n              global: global,\n              conf: conf\n            }).then(function (fb) {\n              fb.firebase.auth().onAuthStateChanged( /*#__PURE__*/function () {\n                var _ref6 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(u) {\n                  return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n                    while (1) {\n                      switch (_context3.prev = _context3.next) {\n                        case 0:\n                          if (logging) {\n                            _context3.next = 3;\n                            break;\n                          }\n\n                          _context3.next = 3;\n                          return userUpdate({\n                            u: u,\n                            set: set,\n                            global: global\n                          });\n\n                        case 3:\n                          if (is(Function)(cb)) cb(u);\n\n                        case 4:\n                        case \"end\":\n                          return _context3.stop();\n                      }\n                    }\n                  }, _callee3);\n                }));\n\n                return function (_x3) {\n                  return _ref6.apply(this, arguments);\n                };\n              }());\n            });\n\n          case 3:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, _callee4);\n  }));\n\n  return function watchUser(_x2) {\n    return _ref5.apply(this, arguments);\n  };\n}();\nwatchUser.props = [\"user\", \"user_init\"];\nexport var logout = /*#__PURE__*/function () {\n  var _ref8 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5(_ref7) {\n    var val, fb, auth, _yield$err, _yield$err2, error;\n\n    return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n      while (1) {\n        switch (_context5.prev = _context5.next) {\n          case 0:\n            val = _ref7.val, fb = _ref7.global.fb;\n            _context5.next = 3;\n            return fb.firebase.auth();\n\n          case 3:\n            auth = _context5.sent;\n            _context5.next = 6;\n            return err(auth.signOut, auth)();\n\n          case 6:\n            _yield$err = _context5.sent;\n            _yield$err2 = _slicedToArray(_yield$err, 1);\n            error = _yield$err2[0];\n            logAlert(error, error, \"something went wrong\");\n            return _context5.abrupt(\"return\", [error]);\n\n          case 11:\n          case \"end\":\n            return _context5.stop();\n        }\n      }\n    }, _callee5);\n  }));\n\n  return function logout(_x4) {\n    return _ref8.apply(this, arguments);\n  };\n}();\nvar user_fields = [\"name\", \"image\", \"about\", \"uid\", \"username\", \"id\"];\n\nvar _login = /*#__PURE__*/function () {\n  var _ref10 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee7(_ref9) {\n    var user, provider, set, _ref9$_add, _add, global, nodb;\n\n    return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n      while (1) {\n        switch (_context7.prev = _context7.next) {\n          case 0:\n            user = _ref9.user, provider = _ref9.provider, set = _ref9.set, _ref9$_add = _ref9._add, _add = _ref9$_add === void 0 ? {} : _ref9$_add, global = _ref9.global, nodb = _ref9.val.nodb;\n            logging = true;\n\n            if (!hasPath([\"user\", \"uid\"])(user)) {\n              _context7.next = 7;\n              break;\n            }\n\n            _context7.next = 5;\n            return global.db.tx(\"users\", user.user.uid, /*#__PURE__*/function () {\n              var _ref12 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6(_ref11) {\n                var data, t, ref, _u, add, _iterator, _step, v, _iterator2, _step2, k;\n\n                return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n                  while (1) {\n                    switch (_context6.prev = _context6.next) {\n                      case 0:\n                        data = _ref11.data, t = _ref11.t, ref = _ref11.ref;\n                        _u = data || {\n                          uid: user.user.uid,\n                          status: \"active\"\n                        };\n                        _u.links = propOr({}, \"links\")(_u);\n                        add = mergeLeft(user.additionalUserInfo, _add);\n                        _iterator = _createForOfIteratorHelper(user.user.providerData);\n\n                        try {\n                          for (_iterator.s(); !(_step = _iterator.n()).done;) {\n                            v = _step.value;\n\n                            if (xNil(link_converter[v.providerId])) {\n                              _u.links[name_map[v.providerId]] = {\n                                id: v.uid,\n                                name: v.displayName,\n                                image: v.photoURL\n                              };\n\n                              if (provider === v.providerId && xNil(add)) {\n                                _u.links[name_map[v.providerId]] = link_converter[v.providerId](_u.links[name_map[v.providerId]], add);\n                              }\n\n                              _u.links[name_map[v.providerId]] = pickBy(identity)(_u.links[name_map[v.providerId]]);\n\n                              if (provider === v.providerId && xNil(add)) {\n                                _iterator2 = _createForOfIteratorHelper(user_fields);\n\n                                try {\n                                  for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {\n                                    k = _step2.value;\n\n                                    if ((isNil(_u[k]) || hasPath([\"profile_update\", k])) && xNil(_u.links[name_map[v.providerId]][k])) {\n                                      _u[k] = _u.links[name_map[v.providerId]][k];\n                                    }\n                                  }\n                                } catch (err) {\n                                  _iterator2.e(err);\n                                } finally {\n                                  _iterator2.f();\n                                }\n                              }\n                            }\n                          }\n                        } catch (err) {\n                          _iterator.e(err);\n                        } finally {\n                          _iterator.f();\n                        }\n\n                        _u = pickBy(identity)(_u);\n\n                        if (!(nodb !== true)) {\n                          _context6.next = 10;\n                          break;\n                        }\n\n                        _context6.next = 10;\n                        return global.db.upsert(_u, \"users\", _u.uid);\n\n                      case 10:\n                      case \"end\":\n                        return _context6.stop();\n                    }\n                  }\n                }, _callee6);\n              }));\n\n              return function (_x6) {\n                return _ref12.apply(this, arguments);\n              };\n            }());\n\n          case 5:\n            _context7.next = 7;\n            return userUpdate({\n              u: user.user,\n              set: set,\n              global: global\n            });\n\n          case 7:\n          case \"end\":\n            return _context7.stop();\n        }\n      }\n    }, _callee7);\n  }));\n\n  return function _login(_x5) {\n    return _ref10.apply(this, arguments);\n  };\n}();\n\nvar getProvider = function getProvider(_ref13) {\n  var provider = _ref13.provider,\n      fb = _ref13.fb;\n  return new fb.firebase.auth[\"\".concat(provider[0].toUpperCase()).concat(provider.slice(1), \"AuthProvider\")]();\n};\n\nvar getData = /*#__PURE__*/function () {\n  var _ref14 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee12(db, conf, url) {\n    var toRSAPublic, toRSAPrivate, fixedEncodeURIComponent, key, key2, pub, text, encrypted, public_key, id, encrypted_id, _getData;\n\n    return _regeneratorRuntime.wrap(function _callee12$(_context12) {\n      while (1) {\n        switch (_context12.prev = _context12.next) {\n          case 0:\n            fixedEncodeURIComponent = function _fixedEncodeURICompon(str) {\n              return encodeURIComponent(str).replace(/[!'()*]/g, function (c) {\n                return \"%\" + c.charCodeAt(0).toString(16);\n              });\n            };\n\n            toRSAPublic = function toRSAPublic(key) {\n              return \"-----BEGIN PUBLIC KEY-----\\n\".concat(key, \"\\n-----END PUBLIC KEY-----\");\n            };\n\n            toRSAPrivate = function toRSAPrivate(key) {\n              return \"-----BEGIN RSA PRIVATE KEY-----\\n\".concat(key, \"\\n-----END RSA PRIVATE KEY-----\");\n            };\n\n            key = new NodeRSA({\n              b: 512\n            });\n            key2 = new NodeRSA(toRSAPublic(conf.rsa[\"public\"]));\n            pub = key.exportKey(\"public\");\n            text = \"Hello RSA!\";\n            encrypted = key2.encrypt(pub, \"base64\");\n            public_key = key.exportKey(\"public\");\n            id = shortid.generate();\n            encrypted_id = key2.encrypt(id, \"base64\");\n            db.set({\n              date: Date.now(),\n              public_key: encrypted\n            }, \"crypt\", id);\n\n            _getData = /*#__PURE__*/function () {\n              var _ref15 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee11(url) {\n                return _regeneratorRuntime.wrap(function _callee11$(_context11) {\n                  while (1) {\n                    switch (_context11.prev = _context11.next) {\n                      case 0:\n                        _context11.next = 2;\n                        return new Promise( /*#__PURE__*/function () {\n                          var _ref16 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee10(res, rej) {\n                            var once, to, ret, unsubscribe;\n                            return _regeneratorRuntime.wrap(function _callee10$(_context10) {\n                              while (1) {\n                                switch (_context10.prev = _context10.next) {\n                                  case 0:\n                                    once = false;\n                                    to = null;\n                                    ret = {};\n                                    _context10.next = 5;\n                                    return db.on(\"crypt\", id, /*#__PURE__*/function () {\n                                      var _ref17 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee8(doc) {\n                                        return _regeneratorRuntime.wrap(function _callee8$(_context8) {\n                                          while (1) {\n                                            switch (_context8.prev = _context8.next) {\n                                              case 0:\n                                                if (!(doc !== null && xNil(doc.value))) {\n                                                  _context8.next = 7;\n                                                  break;\n                                                }\n\n                                                once = true;\n                                                ret.data = JSON.parse(key.decrypt(doc.value, \"utf8\"));\n                                                clearTimeout(to);\n                                                _context8.next = 6;\n                                                return unsubscribe();\n\n                                              case 6:\n                                                if (xNil(ret.response)) {\n                                                  res(ret);\n                                                }\n\n                                              case 7:\n                                              case \"end\":\n                                                return _context8.stop();\n                                            }\n                                          }\n                                        }, _callee8);\n                                      }));\n\n                                      return function (_x13) {\n                                        return _ref17.apply(this, arguments);\n                                      };\n                                    }());\n\n                                  case 5:\n                                    unsubscribe = _context10.sent;\n                                    to = setTimeout( /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee9() {\n                                      return _regeneratorRuntime.wrap(function _callee9$(_context9) {\n                                        while (1) {\n                                          switch (_context9.prev = _context9.next) {\n                                            case 0:\n                                              _context9.prev = 0;\n                                              _context9.next = 3;\n                                              return unsubscribe();\n\n                                            case 3:\n                                              if (xNil(ret.response)) {\n                                                res(ret);\n                                              }\n\n                                              _context9.next = 8;\n                                              break;\n\n                                            case 6:\n                                              _context9.prev = 6;\n                                              _context9.t0 = _context9[\"catch\"](0);\n\n                                            case 8:\n                                            case \"end\":\n                                              return _context9.stop();\n                                          }\n                                        }\n                                      }, _callee9, null, [[0, 6]]);\n                                    })), 20000);\n                                    _context10.next = 9;\n                                    return fetch(\"\".concat(url, \"&crypt_id=\").concat(encodeURIComponent(encrypted_id))).then(function (response) {\n                                      return response.json();\n                                    });\n\n                                  case 9:\n                                    ret.response = _context10.sent;\n                                    console.log(ret.response);\n\n                                    if (xNil(ret.data)) {\n                                      res(ret);\n                                    }\n\n                                  case 12:\n                                  case \"end\":\n                                    return _context10.stop();\n                                }\n                              }\n                            }, _callee10);\n                          }));\n\n                          return function (_x11, _x12) {\n                            return _ref16.apply(this, arguments);\n                          };\n                        }());\n\n                      case 2:\n                        return _context11.abrupt(\"return\", _context11.sent);\n\n                      case 3:\n                      case \"end\":\n                        return _context11.stop();\n                    }\n                  }\n                }, _callee11);\n              }));\n\n              return function _getData(_x10) {\n                return _ref15.apply(this, arguments);\n              };\n            }();\n\n            _context12.next = 15;\n            return _getData(url);\n\n          case 15:\n            return _context12.abrupt(\"return\", _context12.sent);\n\n          case 16:\n          case \"end\":\n            return _context12.stop();\n        }\n      }\n    }, _callee12);\n  }));\n\n  return function getData(_x7, _x8, _x9) {\n    return _ref14.apply(this, arguments);\n  };\n}();\n\nvar login_with = {\n  alis: function () {\n    var _alis = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee13(_ref19) {\n      var conf, code_verifier, code_challenge, purl;\n      return _regeneratorRuntime.wrap(function _callee13$(_context13) {\n        while (1) {\n          switch (_context13.prev = _context13.next) {\n            case 0:\n              conf = _ref19.conf;\n              code_verifier = get_code_verifier();\n              code_challenge = get_code_challenge(code_verifier);\n              purl = \"https://alis.to/oauth-authenticate?client_id=\".concat(conf.alis.client_id, \"&redirect_uri=\").concat(encodeURIComponent(conf.alis.redirect_uri), \"&scope=write&code_challenge=\").concat(code_challenge);\n              setCookie(null, \"alis_verifier\", code_verifier, {\n                path: \"/\"\n              });\n              window.location.href = purl;\n\n            case 6:\n            case \"end\":\n              return _context13.stop();\n          }\n        }\n      }, _callee13);\n    }));\n\n    function alis(_x14) {\n      return _alis.apply(this, arguments);\n    }\n\n    return alis;\n  }()\n};\nexport var login = /*#__PURE__*/function () {\n  var _ref21 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee14(_ref20) {\n    var _ref20$val, provider, _ref20$val$nodb, nodb, set, props, conf, global, _provider, auth, _yield$err3, _yield$err4, error, user;\n\n    return _regeneratorRuntime.wrap(function _callee14$(_context14) {\n      while (1) {\n        switch (_context14.prev = _context14.next) {\n          case 0:\n            _ref20$val = _ref20.val, provider = _ref20$val.provider, _ref20$val$nodb = _ref20$val.nodb, nodb = _ref20$val$nodb === void 0 ? false : _ref20$val$nodb, set = _ref20.set, props = _ref20.props, conf = _ref20.conf, global = _ref20.global;\n\n            if (!xNil(login_with[provider])) {\n              _context14.next = 5;\n              break;\n            }\n\n            _context14.next = 4;\n            return login_with[provider]({\n              set: set,\n              props: props,\n              conf: conf,\n              global: global,\n              val: {\n                nodb: nodb\n              }\n            });\n\n          case 4:\n            return _context14.abrupt(\"return\", _context14.sent);\n\n          case 5:\n            _provider = getProvider({\n              provider: provider,\n              fb: global.fb\n            });\n            _context14.next = 8;\n            return global.fb.firebase.auth();\n\n          case 8:\n            auth = _context14.sent;\n            _context14.next = 11;\n            return err(auth.signInWithPopup, auth)(_provider);\n\n          case 11:\n            _yield$err3 = _context14.sent;\n            _yield$err4 = _slicedToArray(_yield$err3, 2);\n            error = _yield$err4[0];\n            user = _yield$err4[1];\n\n            if (!xNil(error)) {\n              _context14.next = 19;\n              break;\n            }\n\n            alert(\"something went wrong\");\n            _context14.next = 21;\n            break;\n\n          case 19:\n            _context14.next = 21;\n            return _login({\n              user: user,\n              provider: reverse_name_map[provider],\n              set: set,\n              global: global,\n              val: {\n                nodb: nodb\n              }\n            });\n\n          case 21:\n            return _context14.abrupt(\"return\", [error, user]);\n\n          case 22:\n          case \"end\":\n            return _context14.stop();\n        }\n      }\n    }, _callee14);\n  }));\n\n  return function login(_x15) {\n    return _ref21.apply(this, arguments);\n  };\n}();\n\nvar _login_with = /*#__PURE__*/function () {\n  var _ref23 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee15(_ref22) {\n    var set, props, login_url, provider, _ref22$global, fb, db, nodb, conf, _res, auth, _yield$err5, _yield$err6, error, user;\n\n    return _regeneratorRuntime.wrap(function _callee15$(_context15) {\n      while (1) {\n        switch (_context15.prev = _context15.next) {\n          case 0:\n            set = _ref22.set, props = _ref22.props, login_url = _ref22.login_url, provider = _ref22.provider, _ref22$global = _ref22.global, fb = _ref22$global.fb, db = _ref22$global.db, nodb = _ref22.val.nodb, conf = _ref22.conf;\n\n            if (hasPath([\"value\", \"user\", \"uid\"])(props)) {\n              login_url += \"&uid=\".concat(props.user.uid);\n            }\n\n            _context15.next = 4;\n            return getData(db, conf, login_url);\n\n          case 4:\n            _res = _context15.sent;\n\n            if (!(hasPath([\"response\", \"err\"])(_res) && xNil(_res.response.err))) {\n              _context15.next = 8;\n              break;\n            }\n\n            alert(_res.response.err);\n            return _context15.abrupt(\"return\");\n\n          case 8:\n            if (!(hasPath([\"data\", \"err\"])(_res) && xNil(_res.data.err))) {\n              _context15.next = 11;\n              break;\n            }\n\n            alert(_res.data.err);\n            return _context15.abrupt(\"return\");\n\n          case 11:\n            if (!(hasPath([\"data\", \"user\"])(_res) && xNil(_res.data.user))) {\n              _context15.next = 26;\n              break;\n            }\n\n            _context15.next = 14;\n            return fb.firebase.auth();\n\n          case 14:\n            auth = _context15.sent;\n            _context15.next = 17;\n            return err(auth.signInWithCustomToken, auth)(_res.data.token);\n\n          case 17:\n            _yield$err5 = _context15.sent;\n            _yield$err6 = _slicedToArray(_yield$err5, 2);\n            error = _yield$err6[0];\n            user = _yield$err6[1];\n\n            if (!xNil(error)) {\n              _context15.next = 24;\n              break;\n            }\n\n            alert(\"something went wrong\");\n            return _context15.abrupt(\"return\");\n\n          case 24:\n            user.user.providerData.push({\n              providerId: reverse_name_map[provider],\n              uid: user.uid\n            });\n\n            _login({\n              global: {\n                db: db,\n                fb: fb\n              },\n              user: user,\n              provider: reverse_name_map[provider],\n              set: set,\n              _add: _res.data.user,\n              val: {\n                nodb: nodb\n              }\n            });\n\n          case 26:\n            return _context15.abrupt(\"return\");\n\n          case 27:\n          case \"end\":\n            return _context15.stop();\n        }\n      }\n    }, _callee15);\n  }));\n\n  return function _login_with(_x16) {\n    return _ref23.apply(this, arguments);\n  };\n}();\n\nexport var deleteAccount = /*#__PURE__*/function () {\n  var _ref25 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee17(_ref24) {\n    var user, set, _ref24$global, db, fb, account_nodb, _user;\n\n    return _regeneratorRuntime.wrap(function _callee17$(_context17) {\n      while (1) {\n        switch (_context17.prev = _context17.next) {\n          case 0:\n            user = _ref24.val.user, set = _ref24.set, _ref24$global = _ref24.global, db = _ref24$global.db, fb = _ref24$global.fb, account_nodb = _ref24$global.account_nodb;\n\n            if (!(account_nodb !== true)) {\n              _context17.next = 4;\n              break;\n            }\n\n            _context17.next = 4;\n            return db.tx(\"users\", user.uid, /*#__PURE__*/function () {\n              var _ref27 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee16(_ref26) {\n                var t, ref, data, l;\n                return _regeneratorRuntime.wrap(function _callee16$(_context16) {\n                  while (1) {\n                    switch (_context16.prev = _context16.next) {\n                      case 0:\n                        t = _ref26.t, ref = _ref26.ref, data = _ref26.data;\n                        _context16.t0 = _regeneratorRuntime.keys(data.links || {});\n\n                      case 2:\n                        if ((_context16.t1 = _context16.t0()).done) {\n                          _context16.next = 9;\n                          break;\n                        }\n\n                        l = _context16.t1.value;\n\n                        if (!includes(l)([\"steem\", \"alis\"])) {\n                          _context16.next = 7;\n                          break;\n                        }\n\n                        _context16.next = 7;\n                        return db[\"delete\"](\"usermap_\".concat(l), data.links[l].username);\n\n                      case 7:\n                        _context16.next = 2;\n                        break;\n\n                      case 9:\n                        _context16.next = 11;\n                        return t.update(ref, {\n                          status: \"deleted\"\n                        });\n\n                      case 11:\n                        return _context16.abrupt(\"return\", _context16.sent);\n\n                      case 12:\n                      case \"end\":\n                        return _context16.stop();\n                    }\n                  }\n                }, _callee16);\n              }));\n\n              return function (_x18) {\n                return _ref27.apply(this, arguments);\n              };\n            }());\n\n          case 4:\n            _user = fb.firebase.auth().currentUser;\n            _context17.next = 7;\n            return _user[\"delete\"]();\n\n          case 7:\n          case \"end\":\n            return _context17.stop();\n        }\n      }\n    }, _callee17);\n  }));\n\n  return function deleteAccount(_x17) {\n    return _ref25.apply(this, arguments);\n  };\n}();\n\nvar checkUser = /*#__PURE__*/function () {\n  var _ref28 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee19(props) {\n    return _regeneratorRuntime.wrap(function _callee19$(_context19) {\n      while (1) {\n        switch (_context19.prev = _context19.next) {\n          case 0:\n            _context19.next = 2;\n            return new Promise(function (res) {\n              setInterval( /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee18() {\n                return _regeneratorRuntime.wrap(function _callee18$(_context18) {\n                  while (1) {\n                    switch (_context18.prev = _context18.next) {\n                      case 0:\n                        if (!(props.user_init === false)) {\n                          _context18.next = 8;\n                          break;\n                        }\n\n                        _context18.t0 = res;\n                        _context18.next = 4;\n                        return checkUser(props);\n\n                      case 4:\n                        _context18.t1 = _context18.sent;\n                        (0, _context18.t0)(_context18.t1);\n                        _context18.next = 9;\n                        break;\n\n                      case 8:\n                        res(props.user);\n\n                      case 9:\n                      case \"end\":\n                        return _context18.stop();\n                    }\n                  }\n                }, _callee18);\n              })), 500);\n            });\n\n          case 2:\n            return _context19.abrupt(\"return\", _context19.sent);\n\n          case 3:\n          case \"end\":\n            return _context19.stop();\n        }\n      }\n    }, _callee19);\n  }));\n\n  return function checkUser(_x19) {\n    return _ref28.apply(this, arguments);\n  };\n}();\n\nfunction get_code_challenge(str) {\n  var hash = sha256.arrayBuffer(str);\n  return base64url(hash);\n}\n\nfunction get_code_verifier() {\n  var buf = Buffer.alloc(32);\n\n  for (var i = 0; i < buf.length; i++) {\n    var random_num = Math.floor(Math.random() * 256);\n    buf.writeUInt8(random_num, i);\n  }\n\n  return base64url(buf);\n}\n\nexport var check_alis = /*#__PURE__*/function () {\n  var _ref31 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee20(_ref30) {\n    var router, props, set, global, conf, code, cookies, alis_verifier, user, login_url;\n    return _regeneratorRuntime.wrap(function _callee20$(_context20) {\n      while (1) {\n        switch (_context20.prev = _context20.next) {\n          case 0:\n            router = _ref30.val.router, props = _ref30.props, set = _ref30.set, global = _ref30.global, conf = _ref30.conf;\n            code = router.query.code;\n\n            if (!isNil(code)) {\n              _context20.next = 4;\n              break;\n            }\n\n            return _context20.abrupt(\"return\");\n\n          case 4:\n            cookies = parseCookies();\n            alis_verifier = cookies.alis_verifier;\n            _context20.next = 8;\n            return checkUser(props);\n\n          case 8:\n            user = _context20.sent;\n            login_url = \"/api/\".concat($(), \"/alis-oauth?code=\").concat(code, \"&verifier=\").concat(cookies.alis_verifier);\n            console.log(login_url);\n            _context20.next = 13;\n            return _login_with({\n              conf: conf,\n              global: global,\n              login_url: login_url,\n              set: set,\n              props: props,\n              provider: \"alis\",\n              val: {\n                nodb: false\n              }\n            });\n\n          case 13:\n            router.replace(router.pathname, router.pathname, {\n              shallow: true\n            });\n\n          case 14:\n          case \"end\":\n            return _context20.stop();\n        }\n      }\n    }, _callee20);\n  }));\n\n  return function check_alis(_x20) {\n    return _ref31.apply(this, arguments);\n  };\n}();","map":{"version":3,"sources":["/home/basque/hide/next-dapp/nd/account/account.js"],"names":["is","propOr","apply","isNil","hasPath","pickBy","identity","mergeLeft","invertObj","curryN","includes","xNil","initFB","setCookie","parseCookies","destroyCookie","ns","$","NodeRSA","require","base64url","sha256","shortid","err","fn","ctx","ret","args","logAlert","obj","log","_alert_message","console","alert","logging","conf","steem_client","name_map","reverse_name_map","link_converter","_u","add","username","id","profile","id_str","about","description","image","profile_image_url_https","replace","name","picture","data","url","undefined","bio","user_display_name","icon_image_url","self_introduction","user_id","userUpdate","u","set","global","db","account_nodb","uid","displayName","get","user","user_init","watchUser","val","nodb","cb","then","fb","firebase","auth","onAuthStateChanged","Function","props","logout","signOut","error","user_fields","_login","provider","_add","tx","t","ref","status","links","additionalUserInfo","providerData","v","providerId","photoURL","k","upsert","getProvider","toUpperCase","slice","getData","fixedEncodeURIComponent","str","encodeURIComponent","c","charCodeAt","toString","toRSAPublic","key","toRSAPrivate","b","key2","rsa","pub","exportKey","text","encrypted","encrypt","public_key","generate","encrypted_id","date","Date","now","_getData","Promise","res","rej","once","to","on","doc","value","JSON","parse","decrypt","clearTimeout","unsubscribe","response","setTimeout","fetch","json","login_with","alis","code_verifier","get_code_verifier","code_challenge","get_code_challenge","purl","client_id","redirect_uri","path","window","location","href","login","_provider","signInWithPopup","_login_with","login_url","_res","signInWithCustomToken","token","push","deleteAccount","l","update","_user","currentUser","checkUser","setInterval","hash","arrayBuffer","buf","Buffer","alloc","i","length","random_num","Math","floor","random","writeUInt8","check_alis","router","code","query","cookies","alis_verifier","pathname","shallow"],"mappings":"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","sourcesContent":["import {\n  is,\n  propOr,\n  apply,\n  isNil,\n  hasPath,\n  pickBy,\n  identity,\n  mergeLeft,\n  invertObj,\n  curryN,\n  includes\n} from \"ramda\"\n\nimport { xNil } from \"nd/util\"\nimport { initFB } from \"nd/fb\"\nimport { setCookie, parseCookies, destroyCookie } from \"nookies\"\nimport { ns } from \"nd\"\nconst $ = ns(\"account\")\n\nconst NodeRSA = require(\"node-rsa\")\nconst base64url = require(\"base64url\")\nconst sha256 = require(\"js-sha256\")\nconst shortid = require(\"shortid\")\nconst err = (fn, ctx) => async (...args) => {\n  let ret = null\n  let err = null\n  try {\n    ret = await fn.apply(ctx || this, args)\n  } catch (e) {\n    err = e\n  }\n  return [err, ret]\n}\n\nconst logAlert = (obj, log, _alert_message) => {\n  if (xNil(obj)) {\n    if (xNil(log)) console.log(log)\n    if (xNil(alert)) alert(_alert_message)\n  }\n  return xNil(err)\n}\n\nlet logging = false\nlet conf, steem_client\n\nconst name_map = {\n  \"twitter.com\": \"twitter\",\n  \"facebook.com\": \"facebook\",\n  \"google.com\": \"google\",\n  \"github.com\": \"github\",\n  \"alis.to\": \"alis\"\n}\n\nconst reverse_name_map = invertObj(name_map)\n\nconst link_converter = {\n  \"twitter.com\": (_u, add) =>\n    mergeLeft(\n      {\n        username: add.username,\n        id: add.profile.id_str,\n        about: add.profile.description,\n        image: add.profile.profile_image_url_https.replace(/_normal/, \"\")\n      },\n      _u\n    ),\n  \"facebook.com\": (_u, add) =>\n    mergeLeft(\n      {\n        name: add.profile.name,\n        image: hasPath([\"profile\", \"picture\", \"data\", \"url\"])(add)\n          ? add.profile.picture.data.url\n          : undefined\n      },\n      _u\n    ),\n  \"google.com\": (_u, add) =>\n    mergeLeft({ name: add.profile.name, image: add.profile.picture }, _u),\n  \"github.com\": (_u, add) =>\n    mergeLeft(\n      {\n        username: add.username,\n        name: add.profile.name,\n        about: add.profile.bio\n      },\n      _u\n    ),\n  \"alis.to\": (_u, add) =>\n    mergeLeft(\n      {\n        name: add.user_display_name,\n        image: add.icon_image_url,\n        about: add.self_introduction,\n        username: add.user_id\n      },\n      _u\n    )\n}\n\nconst userUpdate = async ({ u, set, global: { db, account_nodb } }) => {\n  const user = isNil(u)\n    ? null\n    : account_nodb\n      ? { uid: u.uid, name: u.displayName }\n      : await db.get(\"users\", u.uid)\n  logging = false\n  set({ user: user, user_init: true })\n}\n\nexport const watchUser = async ({\n  val: { nodb = false, cb },\n  set,\n  conf,\n  global\n}) => {\n  global.account_nodb = nodb\n  initFB({ set, global, conf }).then(fb => {\n    fb.firebase.auth().onAuthStateChanged(async u => {\n      if (!logging) await userUpdate({ u, set, global })\n      if (is(Function)(cb)) cb(u)\n    })\n  })\n}\nwatchUser.props = [\"user\", \"user_init\"]\n\nexport const logout = async ({ val, global: { fb } }) => {\n  const auth = await fb.firebase.auth()\n  const [error] = await err(auth.signOut, auth)()\n  logAlert(error, error, \"something went wrong\")\n  return [error]\n}\n\nconst user_fields = [\"name\", \"image\", \"about\", \"uid\", \"username\", \"id\"]\n\nconst _login = async ({\n  user,\n  provider,\n  set,\n  _add = {},\n  global,\n  val: { nodb }\n}) => {\n  logging = true\n  if (hasPath([\"user\", \"uid\"])(user)) {\n    await global.db.tx(\"users\", user.user.uid, async ({ data, t, ref }) => {\n      let _u = data || { uid: user.user.uid, status: \"active\" }\n      _u.links = propOr({}, \"links\")(_u)\n      const add = mergeLeft(user.additionalUserInfo, _add)\n      for (let v of user.user.providerData) {\n        if (xNil(link_converter[v.providerId])) {\n          _u.links[name_map[v.providerId]] = {\n            id: v.uid,\n            name: v.displayName,\n            image: v.photoURL\n          }\n          if (provider === v.providerId && xNil(add)) {\n            _u.links[name_map[v.providerId]] = link_converter[v.providerId](\n              _u.links[name_map[v.providerId]],\n              add\n            )\n          }\n          _u.links[name_map[v.providerId]] = pickBy(identity)(\n            _u.links[name_map[v.providerId]]\n          )\n          if (provider === v.providerId && xNil(add)) {\n            for (let k of user_fields) {\n              if (\n                (isNil(_u[k]) || hasPath([\"profile_update\", k])) &&\n                xNil(_u.links[name_map[v.providerId]][k])\n              ) {\n                _u[k] = _u.links[name_map[v.providerId]][k]\n              }\n            }\n          }\n        }\n      }\n      _u = pickBy(identity)(_u)\n      if (nodb !== true) await global.db.upsert(_u, \"users\", _u.uid)\n    })\n    await userUpdate({ u: user.user, set, global })\n  }\n}\n\nconst getProvider = ({ provider, fb }) => {\n  return new fb.firebase.auth[\n    `${provider[0].toUpperCase()}${provider.slice(1)}AuthProvider`\n  ]()\n}\n\nconst getData = async (db, conf, url) => {\n  const toRSAPublic = key =>\n    `-----BEGIN PUBLIC KEY-----\\n${key}\\n-----END PUBLIC KEY-----`\n  const toRSAPrivate = key =>\n    `-----BEGIN RSA PRIVATE KEY-----\\n${key}\\n-----END RSA PRIVATE KEY-----`\n  function fixedEncodeURIComponent(str) {\n    return encodeURIComponent(str).replace(/[!'()*]/g, function(c) {\n      return \"%\" + c.charCodeAt(0).toString(16)\n    })\n  }\n  const key = new NodeRSA({ b: 512 })\n  const key2 = new NodeRSA(toRSAPublic(conf.rsa.public))\n  const pub = key.exportKey(\"public\")\n  const text = \"Hello RSA!\"\n  const encrypted = key2.encrypt(pub, \"base64\")\n  const public_key = key.exportKey(\"public\")\n  const id = shortid.generate()\n  const encrypted_id = key2.encrypt(id, \"base64\")\n  db.set({ date: Date.now(), public_key: encrypted }, \"crypt\", id)\n  const _getData = async url => {\n    return await new Promise(async (res, rej) => {\n      let once = false\n      let to = null\n      let ret = {}\n      const unsubscribe = await db.on(\"crypt\", id, async doc => {\n        if (doc !== null && xNil(doc.value)) {\n          once = true\n          ret.data = JSON.parse(key.decrypt(doc.value, \"utf8\"))\n          clearTimeout(to)\n          await unsubscribe()\n          if (xNil(ret.response)) {\n            res(ret)\n          }\n        }\n      })\n      to = setTimeout(async () => {\n        try {\n          await unsubscribe()\n          if (xNil(ret.response)) {\n            res(ret)\n          }\n        } catch (e) {}\n      }, 20000)\n      ret.response = await fetch(\n        `${url}&crypt_id=${encodeURIComponent(encrypted_id)}`\n      ).then(response => response.json())\n      console.log(ret.response)\n      if (xNil(ret.data)) {\n        res(ret)\n      }\n    })\n  }\n  return await _getData(url)\n}\n\nconst login_with = {\n  alis: async ({ conf }) => {\n    const code_verifier = get_code_verifier()\n    const code_challenge = get_code_challenge(code_verifier)\n    const purl = `https://alis.to/oauth-authenticate?client_id=${\n      conf.alis.client_id\n    }&redirect_uri=${encodeURIComponent(\n      conf.alis.redirect_uri\n    )}&scope=write&code_challenge=${code_challenge}`\n    setCookie(null, \"alis_verifier\", code_verifier, { path: \"/\" })\n    window.location.href = purl\n  }\n}\n\nexport const login = async ({\n  val: { provider, nodb = false },\n  set,\n  props,\n  conf,\n  global\n}) => {\n  if (xNil(login_with[provider])) {\n    return await login_with[provider]({\n      set,\n      props,\n      conf,\n      global,\n      val: { nodb }\n    })\n  }\n  const _provider = getProvider({ provider: provider, fb: global.fb })\n  const auth = await global.fb.firebase.auth()\n  const [error, user] = await err(auth.signInWithPopup, auth)(_provider)\n  if (xNil(error)) {\n    alert(\"something went wrong\")\n  } else {\n    await _login({\n      user,\n      provider: reverse_name_map[provider],\n      set,\n      global,\n      val: { nodb }\n    })\n  }\n  return [error, user]\n}\n\nconst _login_with = async ({\n  set,\n  props,\n  login_url,\n  provider,\n  global: { fb, db },\n  val: { nodb },\n  conf\n}) => {\n  if (hasPath([\"value\", \"user\", \"uid\"])(props)) {\n    login_url += `&uid=${props.user.uid}`\n  }\n  const _res = await getData(db, conf, login_url)\n  if (hasPath([\"response\", \"err\"])(_res) && xNil(_res.response.err)) {\n    alert(_res.response.err)\n    return\n  }\n  if (hasPath([\"data\", \"err\"])(_res) && xNil(_res.data.err)) {\n    alert(_res.data.err)\n    return\n  }\n  if (hasPath([\"data\", \"user\"])(_res) && xNil(_res.data.user)) {\n    const auth = await fb.firebase.auth()\n    const [error, user] = await err(auth.signInWithCustomToken, auth)(\n      _res.data.token\n    )\n    if (xNil(error)) {\n      alert(\"something went wrong\")\n      return\n    }\n    user.user.providerData.push({\n      providerId: reverse_name_map[provider],\n      uid: user.uid\n    })\n    _login({\n      global: { db, fb },\n      user,\n      provider: reverse_name_map[provider],\n      set,\n      _add: _res.data.user,\n      val: { nodb }\n    })\n  }\n  return\n}\n\nexport const deleteAccount = async ({\n  val: { user },\n  set,\n  global: { db, fb, account_nodb }\n}) => {\n  if (account_nodb !== true) {\n    await db.tx(\"users\", user.uid, async ({ t, ref, data }) => {\n      for (let l in data.links || {}) {\n        if (includes(l)([\"steem\", \"alis\"])) {\n          await db.delete(`usermap_${l}`, data.links[l].username)\n        }\n      }\n      return await t.update(ref, { status: \"deleted\" })\n    })\n  }\n  let _user = fb.firebase.auth().currentUser\n  await _user.delete()\n}\n\nconst checkUser = async props => {\n  return await new Promise(res => {\n    setInterval(async () => {\n      if (props.user_init === false) {\n        res(await checkUser(props))\n      } else {\n        res(props.user)\n      }\n    }, 500)\n  })\n}\n\nfunction get_code_challenge(str) {\n  const hash = sha256.arrayBuffer(str)\n  return base64url(hash)\n}\n\nfunction get_code_verifier() {\n  const buf = Buffer.alloc(32)\n  for (let i = 0; i < buf.length; i++) {\n    const random_num = Math.floor(Math.random() * 256)\n    buf.writeUInt8(random_num, i)\n  }\n  return base64url(buf)\n}\n\nexport const check_alis = async ({\n  val: { router },\n  props,\n  set,\n  global,\n  conf\n}) => {\n  const code = router.query.code\n  if (isNil(code)) return\n  const cookies = parseCookies()\n  const alis_verifier = cookies.alis_verifier\n  let user = await checkUser(props)\n  let login_url = `/api/${$()}/alis-oauth?code=${code}&verifier=${\n    cookies.alis_verifier\n  }`\n  console.log(login_url)\n  await _login_with({\n    conf,\n    global,\n    login_url,\n    set,\n    props,\n    provider: \"alis\",\n    val: { nodb: false }\n  })\n  router.replace(router.pathname, router.pathname, { shallow: true })\n}\n"]},"metadata":{},"sourceType":"module"}